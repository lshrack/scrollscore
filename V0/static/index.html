<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <link rel="stylesheet" href ="static/styles.css">
</head>
<body>
    <div id="controls">
        <button id="startButton">Start Recording</button>
        <button id="stopButton" disabled>Stop Recording</button>
    </div>
    <div><h1>Hi! {{pageNum}}</h1></div>
    <div id="holder">
        <div id = "wrapper1" class = "canvas-wrapper"></div>
        <div id = "wrapper2" class = "canvas-wrapper"></div>
        <div id = "wrapper3" class = "canvas-wrapper"></div>
        <div id = "wrapper4" class = "canvas-wrapper"></div>
        <div id = "wrapper5" class = "canvas-wrapper"></div>
    </div>
    <canvas id="pdf-viewer"></canvas>
    <script>
        // Function to scroll to a specific page
        function scrollToPage(pageNum) {
            const yOffset = pageNum * window.innerHeight;
            console.log(yOffset);
            window.scroll(0, yOffset);
        }

        // Event listener to receive messages from Flask app
        window.addEventListener('message', function(event) {
            if (event.data.action === 'scrollToPage') {
                scrollToPage(event.data.pageNum);
            }
        });

        async function startRecording() {
            console.log("start recording");
            window.scrollTo(0,800);

            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = function(event) {
                if (event.data.size > 0) {
                    socket.send(event.data);
                }
            }

            mediaRecorder.onstart = function() {
                startButton.disabled = true;
                stopButton.disabled = false;
            }

            mediaRecorder.start();
            
        }

        function stopRecording() {
            window.scrollTo(0,800);
            mediaRecorder.stop();
            startButton.disabled = false;
            stopButton.disabled = true;
        }

        function renderPDF(url, canvasContainer, options) {
            options = options || { scale: 1 };
                
            function renderPage(page, pageNum) {
                var viewport = page.getViewport({ scale: 1.5 });
                var wrapper = document.createElement("div");
                wrapper.id = "wrapper" + page.pageNumber.toString();
                wrapper.className = "canvas-wrapper";
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                var renderContext = {
                canvasContext: ctx,
                viewport: viewport
                };
                
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                wrapper.appendChild(canvas)
                console.log("HI")
                canvasContainer.appendChild(wrapper);
                
                page.render(renderContext);
            }

            function renderPages(pdfDoc) {
                for(var num = 1; num <= pdfDoc.numPages; num++)
                    pdfDoc.getPage(num).then(page => renderPage(page, num));
            }

            pdfjsLib.disableWorker = true;
            pdfjsLib.getDocument(url).promise.then(renderPages);
        }   
        

        renderPDF('/static/concatenated_002.pdf', document.getElementById('holder'));

        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');

        startButton.addEventListener('click', startRecording);
        stopButton.addEventListener('click', stopRecording);

        window.scrollTo(0, 800);
        console.log("hi");
        console.log({{section}});
        $(function() {
            x = ({{ pageNum }}).toString();
            console.log("x = ", x)
        $("html, body").animate({ scrollTop: $("#wrapper" + x).offset().top }, 500);
        });
    </script>

    <script>
        console.log("hi i'm here #wrapper{{pageNum}}")
        x = ({{ pageNum }}).toString();
        console.log("x = ", x);
        str = "#wrapper" + x
        console.log("str", str)
        obj = $(str)
        console.log("obj", obj)

        offset = $("#wrapper" + x).offset();
        console.log("offset", offset);
        $(function() {
            x = ({{ pageNum }}).toString();
            console.log("x = ", x)
        $("html, body").animate({ scrollTop: $("#holder").offset().top }, 500);
        });
    </script>
</body>
</html>